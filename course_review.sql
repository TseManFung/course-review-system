DROP DATABASE IF EXISTS `CRS_DB`;
CREATE DATABASE `CRS_DB` /*!40100 DEFAULT CHARACTER SET utf8mb4 */ /*!80016 DEFAULT ENCRYPTION='N' */;

USE CRS_DB;

CREATE TABLE `User` (
  `userId` varchar(50) PRIMARY KEY NOT NULL COMMENT 'student ID ',
  `email` varchar(100) UNIQUE NOT NULL COMMENT 'User''s email for login and notifications',
  `password` varchar(248) NOT NULL COMMENT 'Hashed password using bcrypt',
  `accessLevel` int NOT NULL DEFAULT 10001 COMMENT '0=admin, 100=moderator, 10000=student, block < 0, 10001=new user',
  `firstName` varchar(50) NOT NULL,
  `lastName` varchar(50) NOT NULL,
  `loginFail` int NOT NULL DEFAULT 0 COMMENT 'Counter for failed login attempts',
  `createdAt` timestamp NOT NULL DEFAULT (now()),
  `updatedAt` timestamp NOT NULL DEFAULT (now()) COMMENT 'Updated on profile changes',
  CONSTRAINT `chk_email_format` CHECK (`email` REGEXP '^[a-zA-Z0-9._%+-]+@[a-zA-Z0-9.-]+\.[a-zA-Z]{2,}$'),
  CONSTRAINT `chk_loginFail` CHECK (`loginFail` >= 0)
);

CREATE TABLE `Department` (
  `departmentId` varchar(10) PRIMARY KEY NOT NULL COMMENT 'department code, e.g., COMP, MATH',
  `name` varchar(100) NOT NULL COMMENT 'Department name, e.g., Department of Computing',
  CONSTRAINT `chk_departmentId_length` CHECK (LENGTH(`departmentId`) >= 3)
);

CREATE TABLE `Course` (
  `courseId` varchar(20) PRIMARY KEY NOT NULL COMMENT 'Unique course code, e.g., COMP1010',
  `departmentId` varchar(10) NOT NULL,
  `name` varchar(100) NOT NULL COMMENT 'Course name, e.g., Introduction to Programming',
  `credits` int NOT NULL COMMENT 'Number of credits, e.g., 3, range: min 0 - max 6',
  `status` ENUM ('C', 'D') NOT NULL DEFAULT 'C' COMMENT 'C = Create, D = Delete',
  CONSTRAINT `chk_credits` CHECK (`credits` BETWEEN 0 AND 6),
  CONSTRAINT `chk_courseId_length` CHECK (LENGTH(`courseId`) >= 6)
);

CREATE TABLE `CourseDescription` (
  `courseId` varchar(20) PRIMARY KEY NOT NULL COMMENT 'Unique course code, e.g., COMP1010',
  `description` text COMMENT 'Course description'
);

CREATE TABLE `Semester` (
  `semesterId` varchar(10) PRIMARY KEY NOT NULL COMMENT 'e.g., 2023sem1, 2024sem2, 2024sem3',
  `name` varchar(50) NOT NULL COMMENT 'e.g., Semester 1 2023',
  CONSTRAINT `chk_semesterId_format` CHECK (`semesterId` REGEXP '^[0-9]{4}sem[1-3]$')
);

CREATE TABLE `Instructor` (
  `instructorId` BIGINT PRIMARY KEY NOT NULL COMMENT 'Snowflake ID for instructor ID, generated by system',
  `firstName` varchar(50) NOT NULL,
  `lastName` varchar(50) NOT NULL,
  `email` varchar(100) COMMENT 'Instructor''s email, optional, input by student',
  `departmentId` varchar(10) NOT NULL,
  `status` ENUM ('C', 'D') NOT NULL DEFAULT 'C' COMMENT 'C = Create, D = Delete',
  CONSTRAINT `chk_instructor_email_format` CHECK (`email` IS NULL OR `email` REGEXP '^[a-zA-Z0-9._%+-]+@[a-zA-Z0-9.-]+\.[a-zA-Z]{2,}$')
);

CREATE TABLE `CourseOffering` (
  `courseId` varchar(20) NOT NULL,
  `semesterId` varchar(10) NOT NULL,
  PRIMARY KEY (`courseId`, `semesterId`)
);

CREATE TABLE `CourseOfferingInstructor` (
  `courseId` varchar(20) NOT NULL,
  `semesterId` varchar(10) NOT NULL,
  `instructorId` BIGINT NOT NULL,
  PRIMARY KEY (`courseId`, `semesterId`, `instructorId`)
);

CREATE TABLE `Review` (
  `reviewId` BIGINT PRIMARY KEY NOT NULL COMMENT 'Snowflake ID for unique review identifier',
  `userId` varchar(50) NOT NULL,
  `courseId` varchar(20) NOT NULL,
  `semesterId` varchar(10) NOT NULL,
  `contentRating` int NOT NULL COMMENT '0-10 for course content',
  `teachingRating` int NOT NULL COMMENT '0-10 for teaching quality',
  `gradingRating` int NOT NULL COMMENT '0-10 for grading fairness',
  `workloadRating` int NOT NULL COMMENT '0-10 for workload intensity',
  `createdAt` timestamp NOT NULL DEFAULT (now()),
  `status` ENUM ('C', 'D') NOT NULL DEFAULT 'C' COMMENT 'C = Create, D = Delete',
  CONSTRAINT `chk_contentRating` CHECK (`contentRating` BETWEEN 0 AND 10),
  CONSTRAINT `chk_teachingRating` CHECK (`teachingRating` BETWEEN 0 AND 10),
  CONSTRAINT `chk_gradingRating` CHECK (`gradingRating` BETWEEN 0 AND 10),
  CONSTRAINT `chk_workloadRating` CHECK (`workloadRating` BETWEEN 0 AND 10)
);

CREATE TABLE `ReviewComment` (
  `reviewId` BIGINT PRIMARY KEY NOT NULL COMMENT 'Snowflake ID for unique review identifier',
  `comment` text COMMENT 'Text of the review'
);

CREATE TABLE `Encouragement` (
  `encouragementId` BIGINT PRIMARY KEY NOT NULL COMMENT 'Snowflake ID for unique identifier',
  `content` varchar(248) not null COMMENT 'Encouragement sentence',
  `status` ENUM ('C', 'D') NOT NULL DEFAULT 'C' COMMENT 'C = Create, D = Delete'
);

ALTER TABLE `Course` ADD FOREIGN KEY (`departmentId`) REFERENCES `Department` (`departmentId`);

ALTER TABLE `CourseDescription` ADD FOREIGN KEY (`courseId`) REFERENCES `Course` (`courseId`);

ALTER TABLE `Instructor` ADD FOREIGN KEY (`departmentId`) REFERENCES `Department` (`departmentId`);

ALTER TABLE `CourseOffering` ADD FOREIGN KEY (`courseId`) REFERENCES `Course` (`courseId`);

ALTER TABLE `CourseOffering` ADD FOREIGN KEY (`semesterId`) REFERENCES `Semester` (`semesterId`);

ALTER TABLE `CourseOfferingInstructor` ADD FOREIGN KEY (`courseId`, `semesterId`) REFERENCES `CourseOffering` (`courseId`, `semesterId`);

ALTER TABLE `CourseOfferingInstructor` ADD FOREIGN KEY (`instructorId`) REFERENCES `Instructor` (`instructorId`);

ALTER TABLE `Review` ADD FOREIGN KEY (`userId`) REFERENCES `User` (`userId`);

ALTER TABLE `Review` ADD FOREIGN KEY (`courseId`, `semesterId`) REFERENCES `CourseOffering` (`courseId`, `semesterId`);

ALTER TABLE `ReviewComment` ADD FOREIGN KEY (`reviewId`) REFERENCES `Review` (`reviewId`);

INSERT INTO `User` (`userId`, `email`, `password`, `accessLevel`, `firstName`, `lastName`, `loginFail`, `createdAt`, `updatedAt`)
VALUES
  ('alice.chan', 'alice.chan@connect.polyu.hk', '$2a$12$/7doXvzEmW5T8Hxrz5gAjuczBBpol58us2CS09MVN9p5SZ90TAjGm', 10000, 'Alice', 'Chan', 0, '2023-09-01 10:00:00', '2023-09-01 10:00:00'),
  ('bob.wong', 'bob.wong@connect.polyu.hk', '$2a$12$/7doXvzEmW5T8Hxrz5gAjuczBBpol58us2CS09MVN9p5SZ90TAjGm', 10000, 'Bob', 'Wong', 1, '2023-09-02 12:00:00', '2023-09-03 15:00:00'),
  ('cathy.lau', 'cathy.lau@connect.polyu.hk', '$2a$12$/7doXvzEmW5T8Hxrz5gAjuczBBpol58us2CS09MVN9p5SZ90TAjGm', 10000, 'Cathy', 'Lau', 0, '2023-09-03 14:00:00', '2023-09-03 14:00:00'),
  ('moderator', 'moderator@polyu.edu.hk', '$2a$12$/7doXvzEmW5T8Hxrz5gAjuczBBpol58us2CS09MVN9p5SZ90TAjGm', 100, 'David', 'Ho', 0, '2023-08-01 09:00:00', '2023-08-01 09:00:00'),
  ('admin', 'admin@polyu.edu.hk', '$2a$12$/7doXvzEmW5T8Hxrz5gAjuczBBpol58us2CS09MVN9p5SZ90TAjGm', 0, 'Emma', 'Ng', 0, '2023-08-01 08:00:00', '2023-08-01 08:00:00');

INSERT INTO `Department` (`departmentId`, `name`)
VALUES
  ('COMP', 'Department of Computing'),
  ('MATH', 'Department of Mathematics');

INSERT INTO `Course` (`courseId`, `departmentId`, `name`, `credits`, `status`)
VALUES
  ('COMP1010', 'COMP', 'Introduction to Programming', 3, 'C'),
  ('COMP2020', 'COMP', 'Database Systems', 3, 'C'),
  ('MATH1010', 'MATH', 'Calculus I', 3, 'C');

INSERT INTO `CourseDescription` (`courseId`, `description`)
VALUES
  ('COMP1010', 'Basic concepts of programming using Python.'),
  ('COMP2020', 'Fundamentals of database design and SQL.'),
  ('MATH1010', 'Introduction to calculus and its applications.');

INSERT INTO `Semester` (`semesterId`, `name`)
VALUES
  ('2023sem1', 'Semester 1 2023'),
  ('2023sem2', 'Semester 2 2023'),
  ('2024sem1', 'Semester 1 2024');

INSERT INTO `Instructor` (`instructorId`, `firstName`, `lastName`, `email`, `departmentId`, `status`)
VALUES
  (1, 'John', 'Lee', 'john.lee@polyu.edu.hk', 'COMP', 'C'),
  (2, 'Mary', 'Cheung', NULL, 'COMP', 'C'),
  (3, 'Peter', 'Wong', 'peter.wong@polyu.edu.hk', 'MATH', 'C');

INSERT INTO `CourseOffering` (`courseId`, `semesterId`)
VALUES
  ('COMP1010', '2023sem1'),
  ('COMP2020', '2023sem2'),
  ('MATH1010', '2023sem1'),
  ('COMP1010', '2024sem1');

INSERT INTO `CourseOfferingInstructor` (`courseId`, `semesterId`, `instructorId`)
VALUES
  ('COMP1010', '2023sem1', 1),
  ('COMP2020', '2023sem2', 2),
  ('MATH1010', '2023sem1', 3),
  ('COMP1010', '2024sem1', 1);

INSERT INTO `Review` (
  `reviewId`, `userId`, `courseId`, `semesterId`,
  `contentRating`, `teachingRating`, `gradingRating`, `workloadRating`,
  `createdAt`, `status`
)
VALUES
  (0, 'alice.chan', 'COMP1010', '2023sem1', 8, 7, 6, 5, '2023-12-01 10:00:00', 'C'),
  (1, 'bob.wong', 'COMP2020', '2023sem2', 6, 5, 4, 7, '2023-12-02 12:00:00', 'C'),
  (2, 'cathy.lau', 'MATH1010', '2023sem1', 9, 8, 9, 4, '2023-12-15 15:00:00', 'C'),
  (3, 'alice.chan', 'COMP1010', '2024sem1', 7, 6, 7, 6, '2023-12-10 09:00:00', 'C'),
  (4, 'bob.wong', 'COMP1010', '2024sem1', 8, 9, 8, 5, '2024-05-01 11:00:00', 'C');

INSERT INTO `ReviewComment` (`reviewId`, `comment`)
VALUES
  (0, '課程內容清晰，但作業量較大。'),
  (1, '老師講解一般，考試難度高。'),
  (2, '很實用的課程，學到很多！'),
  (3, '數學內容有挑戰性，但老師很耐心。'),
  (4, '比上一年進步很多，推薦！');

INSERT INTO `Encouragement` (`encouragementId`, `content`, `status`) VALUES
(10001, 'Your effort makes the course shine, keep it up!', 'C'),
(10002, 'Share your review to help classmates pick great courses!', 'C'),
(10003, 'Every step forward is a step toward success!', 'C'),
(10004, 'Your feedback matters—help improve the learning experience!', 'C'),
(10005, 'Be bold, share your thoughts, you’re awesome!', 'C'),
(10006, 'Stay strong on your learning journey!', 'C'),
(10007, 'This encouragement has been marked as deleted', 'D'),
(10008, 'Your input is key to better courses!', 'C'),
(10009, 'Challenge yourself and achieve greatness!', 'C'),
(10010, 'Thank you for contributing to a better learning community!', 'C');