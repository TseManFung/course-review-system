DROP DATABASE IF EXISTS `CRS_DB`;
CREATE DATABASE `CRS_DB` /*!40100 DEFAULT CHARACTER SET utf8mb4 */ /*!80016 DEFAULT ENCRYPTION='N' */;

USE CRS_DB;

CREATE TABLE `User` (
  `userId` varchar(50) PRIMARY KEY NOT NULL COMMENT 'student ID ',
  `email` varchar(100) UNIQUE NOT NULL COMMENT 'User''s email for login and notifications',
  `password` varchar(255) NOT NULL COMMENT 'Hashed password using bcrypt',
  `accessLevel` int NOT NULL DEFAULT 10000 COMMENT '0=admin, 100=moderator, 10000=student, block < 0',
  `firstName` varchar(50) NOT NULL,
  `lastName` varchar(50) NOT NULL,
  `loginFail` int NOT NULL DEFAULT 0 COMMENT 'Counter for failed login attempts',
  `createdAt` timestamp NOT NULL DEFAULT (now()),
  `updatedAt` timestamp NOT NULL DEFAULT (now()) COMMENT 'Updated on profile changes',
  CONSTRAINT `chk_accessLevel` CHECK (`accessLevel` IN (0, 100, 10000) OR `accessLevel` < 0),
  CONSTRAINT `chk_email_format` CHECK (`email` REGEXP '^[a-zA-Z0-9._%+-]+@[a-zA-Z0-9.-]+\.[a-zA-Z]{2,}$'),
  CONSTRAINT `chk_loginFail` CHECK (`loginFail` >= 0)
);

CREATE TABLE `Department` (
  `departmentId` varchar(10) PRIMARY KEY NOT NULL COMMENT 'department code, e.g., COMP, MATH',
  `name` varchar(100) NOT NULL COMMENT 'Department name, e.g., Department of Computing',
  CONSTRAINT `chk_departmentId_length` CHECK (LENGTH(`departmentId`) >= 3)
);

CREATE TABLE `Course` (
  `courseId` varchar(20) PRIMARY KEY NOT NULL COMMENT 'Unique course code, e.g., COMP1010',
  `departmentId` varchar(10) NOT NULL,
  `name` varchar(100) NOT NULL COMMENT 'Course name, e.g., Introduction to Programming',
  `description` text COMMENT 'Course description',
  `credits` int NOT NULL COMMENT 'Number of credits, e.g., 3, range: min 0 - max 6',
  `status` ENUM ('C', 'D') NOT NULL DEFAULT 'C' COMMENT 'C = Create, D = Delete',
  CONSTRAINT `chk_credits` CHECK (`credits` BETWEEN 0 AND 6),
  CONSTRAINT `chk_courseId_length` CHECK (LENGTH(`courseId`) >= 6)
);

CREATE TABLE `Semester` (
  `semesterId` varchar(10) PRIMARY KEY NOT NULL COMMENT 'e.g., 2023sem1, 2024sem2, 2024sem3',
  `name` varchar(50) NOT NULL COMMENT 'e.g., Semester 1 2023',
  CONSTRAINT `chk_semesterId_format` CHECK (`semesterId` REGEXP '^[0-9]{4}sem[1-3]$')
);

CREATE TABLE `Instructor` (
  `instructorId` int PRIMARY KEY NOT NULL COMMENT 'Snowflake ID for instructor ID, generated by system',
  `firstName` varchar(50) NOT NULL,
  `lastName` varchar(50) NOT NULL,
  `email` varchar(100) COMMENT 'Instructor''s email, optional, input by student',
  `departmentId` varchar(10) NOT NULL,
  `status` ENUM ('C', 'D') NOT NULL DEFAULT 'C' COMMENT 'C = Create, D = Delete',
  CONSTRAINT `chk_instructor_email_format` CHECK (`email` IS NULL OR `email` REGEXP '^[a-zA-Z0-9._%+-]+@[a-zA-Z0-9.-]+\.[a-zA-Z]{2,}$')
);

CREATE TABLE `CourseOffering` (
  `offeringId` int PRIMARY KEY NOT NULL COMMENT 'Snowflake ID for course offering id',
  `courseId` varchar(20) NOT NULL,
  `semesterId` varchar(10) NOT NULL,
);

CREATE TABLE `CourseOfferingInstructor` (
  `offeringId` int NOT NULL,
  `instructorId` int NOT NULL,
  PRIMARY KEY (`offeringId`, `instructorId`)
);

CREATE TABLE `Review` (
  `reviewId` int PRIMARY KEY NOT NULL COMMENT 'Snowflake ID for review id',
  `userId` varchar(50) NOT NULL,
  `offeringId` int NOT NULL,
  `contentRating` int NOT NULL COMMENT '0-10 for course content',
  `teachingRating` int NOT NULL COMMENT '0-10 for teaching quality',
  `gradingRating` int NOT NULL COMMENT '0-10 for grading fairness',
  `workloadRating` int NOT NULL COMMENT '0-10 for workload intensity',
  `comment` text COMMENT 'Text of the review',
  `createdAt` timestamp NOT NULL DEFAULT (now()),
  `status` ENUM ('C', 'D') NOT NULL DEFAULT 'C' COMMENT 'C = Create, D = Delete',
  CONSTRAINT `chk_contentRating` CHECK (`contentRating` BETWEEN 0 AND 10),
  CONSTRAINT `chk_teachingRating` CHECK (`teachingRating` BETWEEN 0 AND 10),
  CONSTRAINT `chk_gradingRating` CHECK (`gradingRating` BETWEEN 0 AND 10),
  CONSTRAINT `chk_workloadRating` CHECK (`workloadRating` BETWEEN 0 AND 10)
);

ALTER TABLE `Course` ADD FOREIGN KEY (`departmentId`) REFERENCES `Department` (`departmentId`);

ALTER TABLE `Instructor` ADD FOREIGN KEY (`departmentId`) REFERENCES `Department` (`departmentId`);

ALTER TABLE `CourseOffering` ADD FOREIGN KEY (`courseId`) REFERENCES `Course` (`courseId`);

ALTER TABLE `CourseOffering` ADD FOREIGN KEY (`semesterId`) REFERENCES `Semester` (`semesterId`);

ALTER TABLE `CourseOfferingInstructor` ADD FOREIGN KEY (`offeringId`) REFERENCES `CourseOffering` (`offeringId`);

ALTER TABLE `CourseOfferingInstructor` ADD FOREIGN KEY (`instructorId`) REFERENCES `Instructor` (`instructorId`);

ALTER TABLE `Review` ADD FOREIGN KEY (`userId`) REFERENCES `User` (`userId`);

ALTER TABLE `Review` ADD FOREIGN KEY (`offeringId`) REFERENCES `CourseOffering` (`offeringId`);

INSERT INTO `User` (`userId`, `email`, `password`, `accessLevel`, `firstName`, `lastName`, `loginFail`, `createdAt`, `updatedAt`)
VALUES
  ('S001', 'alice.chan@connect.polyu.hk', '$2a$12$/7doXvzEmW5T8Hxrz5gAjuczBBpol58us2CS09MVN9p5SZ90TAjGm', 10000, 'Alice', 'Chan', 0, '2023-09-01 10:00:00', '2023-09-01 10:00:00'),
  ('S002', 'bob.wong@connect.polyu.hk', '$2a$12$/7doXvzEmW5T8Hxrz5gAjuczBBpol58us2CS09MVN9p5SZ90TAjGm', 10000, 'Bob', 'Wong', 1, '2023-09-02 12:00:00', '2023-09-03 15:00:00'),
  ('S003', 'cathy.lau@connect.polyu.hk', '$2a$12$/7doXvzEmW5T8Hxrz5gAjuczBBpol58us2CS09MVN9p5SZ90TAjGm', 10000, 'Cathy', 'Lau', 0, '2023-09-03 14:00:00', '2023-09-03 14:00:00'),
  ('M001', 'moderator@polyu.edu.hk', '$2a$12$/7doXvzEmW5T8Hxrz5gAjuczBBpol58us2CS09MVN9p5SZ90TAjGm', 100, 'David', 'Ho', 0, '2023-08-01 09:00:00', '2023-08-01 09:00:00'),
  ('A001', 'admin@polyu.edu.hk', '$2a$12$/7doXvzEmW5T8Hxrz5gAjuczBBpol58us2CS09MVN9p5SZ90TAjGm', 0, 'Emma', 'Ng', 0, '2023-08-01 08:00:00', '2023-08-01 08:00:00');

-- Department 表: 2 個學系
INSERT INTO `Department` (`departmentId`, `name`)
VALUES
  ('COMP', 'Department of Computing'),
  ('MATH', 'Department of Mathematics');

-- Course 表: 3 門課程
INSERT INTO `Course` (`courseId`, `departmentId`, `name`, `description`, `credits`, `status`)
VALUES
  ('COMP1010', 'COMP', 'Introduction to Programming', 'Basic concepts of programming using Python.', 3, 'C'),
  ('COMP2020', 'COMP', 'Database Systems', 'Fundamentals of database design and SQL.', 3, 'C'),
  ('MATH1010', 'MATH', 'Calculus I', 'Introduction to calculus and its applications.', 3, 'C');

-- Semester 表: 3 個學期
INSERT INTO `Semester` (`semesterId`, `name`)
VALUES
  ('2023sem1', 'Semester 1 2023'),
  ('2023sem2', 'Semester 2 2023'),
  ('2024sem1', 'Semester 1 2024');

-- Instructor 表: 3 名教師
INSERT INTO `Instructor` (`instructorId`, `firstName`, `lastName`, `email`, `departmentId`, `status`)
VALUES
  (1, 'John', 'Lee', 'john.lee@polyu.edu.hk', 'COMP', 'C'),
  (2, 'Mary', 'Cheung', NULL, 'COMP', 'C'),
  (3, 'Peter', 'Wong', 'peter.wong@polyu.edu.hk', 'MATH', 'C');

-- CourseOffering 表: 4 個課程開設
INSERT INTO `CourseOffering` (`offeringId`, `courseId`, `semesterId`)
VALUES
  (0, 'COMP1010', '2023sem1'),
  (1, 'COMP2020', '2023sem2'),
  (2, 'MATH1010', '2023sem1'),
  (3, 'COMP1010', '2024sem1');

-- CourseOfferingInstructor 表: 課程與教師關聯
INSERT INTO `CourseOfferingInstructor` (`offeringId`, `instructorId`)
VALUES
  (0, 1),
  (1, 2),
  (2, 3),
  (3, 1);

-- Review 表: 5 條課程評論
INSERT INTO `Review` (`reviewId`, `userId`, `offeringId`, `contentRating`, `teachingRating`, `gradingRating`, `workloadRating`, `comment`, `createdAt`, `status`)
VALUES
  (0, 'S001', 0, 8, 7, 6, 5, '課程內容清晰，但作業量較大。', '2023-12-01 10:00:00', 'C'),
  (1, 'S002', 1, 6, 5, 4, 7, '老師講解一般，考試難度高。', '2023-12-02 12:00:00', 'C'),
  (2, 'S003', 2, 9, 8, 9, 4, '很實用的課程，學到很多！', '2023-12-15 15:00:00', 'C'),
  (3, 'S001', 3, 7, 6, 7, 6, '數學內容有挑戰性，但老師很耐心。', '2023-12-10 09:00:00', 'C'),
  (4, 'S002', 3, 8, 9, 8, 5, '比上一年進步很多，推薦！', '2024-05-01 11:00:00', 'C');